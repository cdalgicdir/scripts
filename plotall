#! /bin/bash

#plotlist=('dist_CNi-CNi4_avg.xvg' 'dih_CN-CA-CN-CA_avg.xvg' 'dih_CA-CN-CA-CN_avg.xvg' 'table_L_wall0.xvg' 'tablep.xvg')
#plotlist=('dist_CNi-CNi4_avg.xvg' 'dih_CN-CA-CN-CA_avg.xvg' 'dih_CA-CN-CA-CN_avg.xvg' 'ang_CA-CN-CA_avg.xvg' 'ang_CN-CA-CN_avg.xvg')
plotlist=('dist_CNi-CNi4_avg.xvg' 'dih_CN-CA-CN-CA_avg.xvg' 'dih_CA-CN-CA-CN_avg.xvg' 'dih_A-CN-A-CN_avg.xvg' 'dih_A-CN-CA-CN_avg.xvg' 'dih_CA-CN-A-CN_avg.xvg' 'dih_CN-A-CN-A_avg.xvg' 'dih_CN-A-CN-CA_avg.xvg' 'dih_CN-CA-CN-A_avg.xvg')

plcomms=''
q="'"
gplot='gplot'
#using=" using 1:2 "
with=" with lines lw 3 "
histdir="histograms"
terminal="set terminal wxt enhanced"
output=""
termset=""

plot () {
        gplot $output -c "$xtics" -c "$yrange" -c "$xrange" -t "$title" -c "$keypos" -c "set ylabel '$ylabel'" -c "set xlabel '$xlabel'" -c "$terminal" -- "$plcomms"
}

printcommands () {
    if [[ $noplottab == true ]]; then
        #echo "plot $plotfiles" | sed 's/,/,\\\n /g'
        echo -e "plot\\\\\n $plcomms" | sed 's/,/,\\\n /g'
	echo
    else
        echo "plot $plcomms"
	echo
    fi
}

# parse through command and obtain options and name of directories to plot

if [[ $# -eq 0 ]];then
    echo "Error! Specify a directory name!"
    echo "Usage: $ plotall dirname"
    exit 1
fi

while [[ $# -gt 0 ]]; do
    case $1 in

        -png)
            terminal='set terminal pngcairo size 800,600 enhanced font "Gill Sans,16" linewidth 3 rounded'
	    termset="png"
            shift;;

        -pdf)
	    termset="pdf"
            terminal='set terminal pdfcairo enhanced font "Gill Sans,16" linewidth 3 rounded'
            shift;;
        -t)
            writetitrs=true
            for z in $2; do
                titrs=(${titrs[*]} $z)
            done
            shift 2
            ;;

        -n | -nop | -noplot)
            noplot=true
            noplottab=false
            shift 1;;

        -nt | -nopt)
            noplot=true
            noplottab=true
            shift 1;;

        -h|--h|-help|--help)
            echo "Usage: plotall [directories]"
            ;;

        *)
            folders=(${folders[*]} $1)
            shift
            ;;
    esac
done

IFS=$'\t\n'
len_plots=`expr ${#plots[@]} - 1`
i=0

for f in ${plotlist[@]}; do

    if [[ $f == table* ]]; then
	using=" using 1:6 "
	histdir="."
	xlabel='r (nm)'
	ylabel='V(r) (kJ/mol)'
	xrange='set xrange [:2]'
	yrange='set yrange [:20]'
	keypos='set key right'
    elif [[ $f == dih_* ]]; then
	using=" using 1:2 "
	histdir="histograms"
	xlabel='{/Symbol f} (degrees)'
	ylabel='P({/Symbol f})'
	xrange='set xrange [-180:180]'
	yrange='set yrange [:]'
	xtics='set xtics 45'
	keypos='set key left Left reverse'
    elif [[ $f == ang_* ]]; then
	using=" using 1:2 "
	histdir="histograms"
	xlabel='{/Symbol t} (degrees)'
	ylabel='P({/Symbol t})'
	xrange='set xrange [-180:180]'
	yrange='set yrange [:]'
	xtics='set xtics 45'
	keypos='set key left'
    else 
	using=" using 1:2 "
	histdir="histograms"
	xlabel='r (nm)'
	ylabel='P(r)'
	xrange='set xrange [:]'
	yrange='set yrange [:]'
	keypos='set key left'
    fi
    plcomms=''
    tmp=`echo "${f}" | sed 's/_/-/g'` && title=${tmp%.xvg}
    [[ $termset != "" ]] && output="-o${title}.${termset}"
    for dir in ${folders[@]}; do
	address=$dir/$histdir/$f
	[[ ! -e "${address}" ]] && continue
	if [[ $dir == cg-ala-CACB* ]]; then
	    dir="ala-CACB"
	elif [[ $dir == cg-ala-CA* ]]; then
	    dir="ala-CA"
	elif [[ $dir == cg-only-CA* ]]; then
	    dir="only-CA"
	elif [[ $dir == cg-CAB* ]]; then
	    dir="CAB"
	fi
	plcomms=${plcomms}${q}${address}${q}${using}${with}'t '${q}${dir}${q},
    done
    if [[ $noplot == true ]]; then
	printcommands
    else
	[[ "${plcomms}" == "" ]] && continue
	plot $@
    fi
done
